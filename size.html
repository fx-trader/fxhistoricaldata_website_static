<html>
    <head>
        <script type="text/javascript" src="//code.jquery.com/jquery-2.2.1.min.js"></script>
        <script type="text/javascript" src="//cdn.jsdelivr.net/jquery.cookie/1.4.1/jquery.cookie.js"></script>
        <script type="text/javascript">
        "use strict";
            $(document).ready(function() {
                var symbolCurrencyMap = {
                    AUD_JPY: ["JPY",100,1],
                    AUD_NZD: ["NZD",10000,1],
                    AUD_USD: ["USD",10000,1],
                    CHF_JPY: ["JPY",100,1],
                    EUR_CAD: ["CAD",10000,1],
                    EUR_CHF: ["CHF",10000,1],
                    EUR_GBP: ["GBP",10000,1],
                    EUR_JPY: ["JPY",100,1],
                    EUR_USD: ["USD",10000,1],
                    GBP_CHF: ["CHF",10000,1],
                    GBP_JPY: ["JPY",100,1],
                    GBP_NZD: ["NZD",10000,1],
                    GBP_USD: ["USD",10000,1],
                    NZD_JPY: ["JPY",100,1],
                    NZD_USD: ["USD",10000,1],
                    USD_CAD: ["CAD",10000,1],
                    USD_CHF: ["CHF",10000,1],
                    USD_JPY: ["JPY",100,1],
                    XAG_USD: ["USD",100,1],
                    XAU_USD: ["USD",10,1],
                    XCU_USD: ["USD",2000,1],
                    XPD_USD: ["USD",10,1],
                    XPT_USD: ["USD",10,1],
                    BCO_USD: ["USD",100,1],
                    WTICO_USD: ["USD",100,1],
                    AU200_AUD: ["AUD",1,1],
                    ES35_EUR: ["EUR",1,1],
                    FR40_EUR: ["EUR",1,1],
                    DE30_EUR: ["EUR",1,1],
                    HK33_HKD: ["HKD",1,1],
                    IT40_EUR: ["EUR",1,1],
                    JP225_JPY: ["JPY",1,1],
                    NAS100_USD: ["USD",1,1],
                    SPX500_USD: ["USD",1,1],
                    UK100_GBP: ["GBP",1,1],
                    US30_USD: ["USD",1,1],
                    DE10YB_EUR: ["EUR",100,10],
                    NATGAS_USD: ["USD",1000,1],
                };

                $('#entry').keyup(function() {
                        $('#currentPriceTime').text('');
                        });
                $('#getCurrentPrice').click(function() {
                    var symbol = $('#instrument').val();
                    $.getJSON("//api.fxhistoricaldata.com/indicators?timeframe=5min&expression=close&instruments="+symbol+"&jsoncallback=?",
                        function(data) {
                            $('#entry').val(data['results'][symbol]['data'][0][1]).change();
                            $('#currentPriceTime').text(data['results'][symbol]['data'][0][0]);
                        });
                    });

                $('#getPreviousHigh').click(function() {
                    var symbol = $('#instrument').val();
                    $.getJSON("//api.fxhistoricaldata.com/indicators?timeframe=hour&expression=max(high,396)&instruments="+symbol+"&jsoncallback=?",
                        function(data) {
                            $('#exit').val(data['results'][symbol]['data'][0][1]).change();
                        });
                    });

                $('#getPreviousLow').click(function() {
                    var symbol = $('#instrument').val();
                    $.getJSON("//api.fxhistoricaldata.com/indicators?timeframe=hour&expression=min(low,396)&instruments="+symbol+"&jsoncallback=?",
                        function(data) {
                            $('#exit').val(data['results'][symbol]['data'][0][1]).change();
                        });
                    });

                $('.recalculate').change(calculatePositionSize);
                $('#positionSize').change(calculateMaxLoss);
                $('.persistValue').change(function() {
                        $.cookie(this.name, this.value, { expires: 30 });
                    });

                $('.persistValue').each(function(index, obj) {
                        var cookieValue = $.cookie(obj.name);
                        $(obj).val(cookieValue);
                    });

                var $maxLossCookie = $.cookie('maxLoss');
                if ($maxLossCookie) {
                    $('#maxLoss').val($maxLossCookie);
                }

                function getRatioCurrency() {
                    var symbolCurrency = symbolCurrencyMap[$('#instrument').val()][0];
                    var accountCurrency = $('#accountCurrency').val();
                    if (symbolCurrency === accountCurrency) {
                        return;
                    }

                    var symbol = accountCurrency + symbolCurrency;
                    return symbol;
                }

                function calculateMaxLoss() {
                    var $positionSize = $('#positionSize').val();
                    var $entry = $('#entry').val();
                    var $exit = $('#exit').val();

                    if (!$positionSize || !$entry || !$exit) {
                        return;
                    }

                    var $ratioCurrency = getRatioCurrency();
                    if ($ratioCurrency) {
                        $.getJSON("//api.fxhistoricaldata.com/lastclose?s="+$ratioCurrency+"&jsoncallback=?",
                            function(data) {
                                var $ratio = data[$ratioCurrency][1];
                                var $maxLoss = parseInt($positionSize * ($entry - $exit) / $ratio, 10);
                                $('#maxLoss').val($maxLoss);
                                setTextExplanation($entry, $exit, $positionSize, $maxLoss);
                            }
                        );
                    } else {
                        var $maxLoss = parseInt($positionSize * ($entry - $exit), 10);
                        $('#maxLoss').val($maxLoss);
                        setTextExplanation($entry, $exit, $positionSize, $maxLoss);
                    }
                }

                function setTextExplanation($entry, $exit, $positionSize, $maxLoss) {
                    var $longshort = ($entry > $exit ? 'buy' : 'short');
                    var $instrument = $('#instrument').val();
                    var $accountCurrency = $('#accountCurrency').val();
                    $('#textualExplanation').text('If you ' + $longshort + ' ' + parseInt(Math.abs($positionSize), 10) + ' ' + $instrument + ' at ' + $entry + ', and hit stop loss at ' + $exit + ', your loss will be ' + $maxLoss + ' ' + $accountCurrency);
                }

                function calculatePositionSize() {
                    var $maxLoss = $('#maxLoss').val();
                    var $entry = $('#entry').val();
                    var $exit = $('#exit').val();

                    if (!$maxLoss || !$entry || !$exit) {
                        return;
                    }

                    var $ratioCurrency = getRatioCurrency();
                    if ($ratioCurrency) {
                        $.getJSON("//api.fxhistoricaldata.com/lastclose?s="+$ratioCurrency+"&jsoncallback=?",
                            function(data) {
                                var $ratio = data[$ratioCurrency][1];
                                var $positionSize = parseInt($maxLoss * $ratio / ($entry - $exit), 10) / symbolCurrencyMap[ $('#instrument').val() ][2];
                                $('#positionSize').val($positionSize);
                                setTextExplanation($entry, $exit, $positionSize, $maxLoss);
                                $('#sizePerPoint').val($maxLoss / ($entry-$exit) / symbolCurrencyMap[ $('#instrument').val() ][1] / $ratio  );
                            }
                        );
                    } else {
                        var $positionSize = parseInt($maxLoss / ($entry - $exit), 10);
                        $('#positionSize').val($positionSize);
                        setTextExplanation($entry, $exit, $positionSize, $maxLoss);
                        $('#sizePerPoint').val($maxLoss / ($entry-$exit) / symbolCurrencyMap[ $('#instrument').val() ][1]  );
                    }
                }

                $('#getCurrentPrice').click();

            });
        </script>
        <style type="text/css">

            html {
                font: 90%/1.3 arial,sans-serif;
                padding:1em;
                background:#fafafa;
            }

            body {
                padding: 0;
                margin: 20px;
                color: #333;
                background: #fff;
                font: 12px arial, verdana, sans-serif;
            }

            fieldset {
                margin: 1em 0;
                border: none;
                border-top: 1px solid #ccc;
            }

            legend {
                margin: 1em 0;
                padding: 0 .5em;
                color: #036;
                background: transparent;
                font-size: 1.3em;
                font-weight: bold;
            }
            label {
                float: left;
                width: 100px;
                padding: 0 1em;
                text-align: right;
            }
            fieldset div {
                margin-bottom: .1em;
                padding: 0;
                display: block;
            }
            fieldset div input, fieldset div select {
                width: 150px;
                border-top: 1px solid #555;
                border-left: 1px solid #555;
                border-bottom: 1px solid #ccc;
                border-right: 1px solid #ccc;
                padding: 1px;
                color: #333;
            }
            fieldset div button {
                padding: 0px;
                width: 150px;
            }
            button#getPreviousLow, button#getPreviousHigh {
                width: 74px;
            }

            input:focus, textarea:focus {
                background: #efefef;
                color: #000;
            }
        </style>
    </head>
    <body>
        <a href="size.html">Position Size</a>
        <form>
            <fieldset><legend>Position Size</legend>
                <div>
                    <label for="instrument">Instrument</label>
                    <select name="instrument" id="instrument" class="persistValue">
                        <option value="AUDJPY">AUD_JPY</option>
                        <option value="AUDNZD">AUD_NZD</option>
                        <option value="AUDUSD">AUD_USD</option>
                        <option value="CHFJPY">CHF_JPY</option>
                        <option value="EURCAD">EUR_CAD</option>
                        <option value="EURCHF">EUR_CHF</option>
                        <option value="EURGBP">EUR_GBP</option>
                        <option value="EURJPY">EUR_JPY</option>
                        <option value="EURUSD">EUR_USD</option>
                        <option value="GBPCHF">GBP_CHF</option>
                        <option value="GBPJPY">GBP_JPY</option>
                        <option value="GBPNZD">GBP_NZD</option>
                        <option value="GBPUSD">GBP_USD</option>
                        <option value="NZDJPY">NZD_JPY</option>
                        <option value="NZDUSD">NZD_USD</option>
                        <option value="USDCAD">USD_CAD</option>
                        <option value="USDCHF">USD_CHF</option>
                        <option value="USDJPY">USD_JPY</option>
                        <option value="XAGUSD">XAG_USD</option>
                        <option value="XAUUSD">XAU_USD</option>
                        <option value="Copper">XCU_USD</option>
                        <option value="AUS200">AU200_AUD</option>
                        <option value="ESP35">ES35_EUR</option>
                        <option value="FRA40">FR40_EUR</option>
                        <option value="GER30">DE30_EUR</option>
                        <option value="HKG33">HK33_EUR</option>
                        <option value="ITA40">IT40_EUR</option>
                        <option value="JPN225">JP225_JPY</option>
                        <option value="NAS100">NAS100_USD</option>
                        <option value="SPX500">SPX500_USD</option>
                        <option value="UK100">UK100_GBP</option>
                        <option value="US30">US30_USD</option>
                        <option value="UKOil">BCO_USD</option>
                        <option value="USOil">WTICO_USD</option>
                        <option value="Palladium">XPD_USD</option>
                        <option value="Platinum">XPT_USD</option>
                        <option value="Bund">DE10YB_EUR</option>
                        <option value="NGAS">NATGAS_USD</option>
                    </select>
                </div>
                <div>
                    <label for="entry">Entry</label>
                    <input type="text" name="entry" id="entry" class="recalculate" />
                    <button type="button" id="getCurrentPrice">Last Known Price</button>
                    <span id="currentPriceTime"></span>
                </div>
                <div>
                    <label for="exit">Stop Loss</label>
                    <input type="text" name="exit" id="exit" class="recalculate" />
                    <button type="button" id="getPreviousLow">Long</button>
                    <button type="button" id="getPreviousHigh">Short</button>
                </div>
                <div>
                    <label for="maxLoss">Max Loss</label>
                    <input type="text" name="maxLoss" id="maxLoss" class="recalculate persistValue" />
                    <select name="accountCurrency" id="accountCurrency" class="recalculate">
                        <option value="GBP">GBP</option>
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                        <option value="CHF">CHF</option>
                    </select>
                </div>
                <div>
                    <label for="positionSize">Position Size</label>
                    <input type="text" name="positionSize" id="positionSize" />
                </div>
                <div>
                    <label for="sizePerPoint">Size per point</label>
                    <input type="text" name="sizePerPoint" id="sizePerPoint" />
                </div>
            </fieldset>
        </form>
        <div id="textualExplanation"></div>
    </body>
</html>
